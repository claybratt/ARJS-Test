<!doctype HTML>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/dev/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0px; overflow: hidden;">

    <script>
      AFRAME.registerComponent('registerevents', {
        init: function () {
          const marker = this.el;

          // cache references
          this.follower = document.querySelector("#follower");
          this.followerPlane = document.querySelector("#followerPlane");

          // internal state
          this.markerVisible = false;

          marker.addEventListener('markerFound', () => {
            // check if marker is found for the first time;
            if (this.follower.getAttribute("active") === "0") {
              this.follower.setAttribute("active", "1");
              // visibility is an entity attribute, not material
              this.followerPlane.setAttribute("visible", true);
            }
            this.markerVisible = true;
          });

          marker.addEventListener('markerLost', () => {
            this.markerVisible = false;
          });

          this.p = new THREE.Vector3();
          this.q = new THREE.Quaternion();
          this.s = new THREE.Vector3();
        },

        tick: function (time, deltaTime) {
          if (this.markerVisible) {
            const marker = this.el;

            const lerpAmount = 0.5;

            marker.object3D.getWorldPosition(this.p);
            marker.object3D.getWorldQuaternion(this.q);
            marker.object3D.getWorldScale(this.s);

            this.follower.object3D.position.lerp(this.p, lerpAmount);
            this.follower.object3D.quaternion.slerp(this.q, lerpAmount);
            this.follower.object3D.scale.lerp(this.s, lerpAmount);

            this.followerPlane.setAttribute("color", "green");
          } else {
            this.followerPlane.setAttribute("color", "red");
          }
        }
      });
    </script>

    <a-scene
      embedded
      vr-mode-ui="enabled: false;"
      arjs="debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    >
      <a-assets>
        <img id="grid" src="images/border.png" />
      </a-assets>

      <a-marker 
		preset='hiro'
        id="baseMarker"
        registerevents
      >
      </a-marker>

      <!-- this entity will move (lerp) towards the marker when visible;
           turns green when marker visible, red when marker not visible -->
      <a-entity id="follower" active="0">
        <a-plane
          id="followerPlane"
          position="0 0 0"
          rotation="-90 0 0"
          color="green"
          material="src:#grid; transparent:true; opacity:0.90; side:double;"
          visible="false"
        >
        </a-plane>
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
