<!doctype HTML>
<html>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/dev/aframe/build/aframe-ar.js"></script>
<body style="margin: 0px; overflow: hidden;">

<script>

// store visibility data in object;
//  can only draw line when both are visible.
let markerVisible = { m0: false, m1: false };

AFRAME.registerComponent('registerevents', {
    init: function () 
    {
        let marker = this.el;
        
        marker.addEventListener('markerFound', function() {
            markerVisible[ marker.id ] = true;
        });

        marker.addEventListener('markerLost', function() {
            markerVisible[ marker.id ] = false;
        });
    }
});

AFRAME.registerComponent('run', {
    init: function()
    {
        this.m0 = document.querySelector("#m0");
        this.m1 = document.querySelector("#m1");
        this.m2 = document.querySelector("#m2");
        this.m3 = document.querySelector("#m3");
        this.m4 = document.querySelector("#m4");
		
        this.p0 = new THREE.Vector3();
        this.p1 = new THREE.Vector3(); 
        this.p2 = new THREE.Vector3(); 
        this.p3 = new THREE.Vector3(); 
        this.p4 = new THREE.Vector3(); 
        
        let geometry = new THREE.CylinderGeometry( 0.05, 0.05, 1, 12 );
        geometry.applyMatrix( new THREE.Matrix4().makeTranslation( 0, 0.5, 0 ) );
        geometry.applyMatrix( new THREE.Matrix4().makeRotationX( THREE.Math.degToRad( 90 ) ) );
        let material = new THREE.MeshLambertMaterial( {color: 0xFF0000} );
		
        this.cylinder0 = new THREE.Mesh( geometry, material );
        this.cylinder1 = new THREE.Mesh( geometry, material );
        this.cylinder2 = new THREE.Mesh( geometry, material );
        this.cylinder3 = new THREE.Mesh( geometry, material );
        this.cylinderGroup0 = document.querySelector('#cylinderGroup0').object3D;
        this.cylinderGroup1 = document.querySelector('#cylinderGroup0').object3D;
        this.cylinderGroup2 = document.querySelector('#cylinderGroup0').object3D;
        this.cylinderGroup3 = document.querySelector('#cylinderGroup0').object3D;
        this.cylinderGroup0.add( this.cylinder0 );
        this.cylinderGroup1.add( this.cylinder1 );
        this.cylinderGroup2.add( this.cylinder2 );
        this.cylinderGroup3.add( this.cylinder3 );
    },
    
    tick: function (time, deltaTime) 
    {
        if ( markerVisible["m0"] && markerVisible["m1"] )
        {
            this.m0.object3D.getWorldPosition(this.p0);
            this.m1.object3D.getWorldPosition(this.p1);
            
            let distance = this.p0.distanceTo( this.p1 );
            this.cylinderGroup0.lookAt( this.p1 );            
            this.cylinder0.scale.set(1,1,distance);
            this.cylinder0.visible = true;
        }
        else
        {
            this.cylinder0.visible = false;
        }
		
        if ( markerVisible["m1"] && markerVisible["m2"] )
        {
            this.m1.object3D.getWorldPosition(this.p1);
            this.m2.object3D.getWorldPosition(this.p2);
            
            let distance = this.p1.distanceTo( this.p2 );
            this.cylinderGroup1.lookAt( this.p2 );            
            this.cylinder1.scale.set(1,1,distance);
            this.cylinder1.visible = true;
        }
        else
        {
            this.cylinder1.visible = false;
        }
		
        if ( markerVisible["m2"] && markerVisible["m3"] )
        {
            this.m2.object3D.getWorldPosition(this.p2);
            this.m3.object3D.getWorldPosition(this.p3);
            
            let distance = this.p2.distanceTo( this.p3 );
            this.cylinderGroup2.lookAt( this.p3 );            
            this.cylinder2.scale.set(1,1,distance);
            this.cylinder2.visible = true;
        }
        else
        {
            this.cylinder2.visible = false;
        }
		
        if ( markerVisible["m3"] && markerVisible["m4"] )
        {
            this.m3.object3D.getWorldPosition(this.p3);
            this.m4.object3D.getWorldPosition(this.p4);
            
            let distance = this.p3.distanceTo( this.p4 );
            this.cylinderGroup3.lookAt( this.p4 );            
            this.cylinder3.scale.set(1,1,distance);
            this.cylinder3.visible = true;
        }
        else
        {
            this.cylinder3.visible = false;
        }
    }
});

</script>

<a-scene embedded vr-mode-ui="enabled: false;" arjs="debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 4x4_BCH_13_5_5;">

    <a-assets>
		<img id="grid" src="images/border.png" />
	</a-assets>

    <a-marker type="barcode" value="0" id="m0" registerevents>
        <a-sphere radius="0.10" color="red"></a-sphere>
        <!-- this group rotates the cylinder to point at marker m1 -->
        <a-entity id="cylinderGroup0"></a-entity>
    </a-marker>

    <a-marker type="barcode" value="1" id="m1" registerevents>
        <a-sphere radius="0.10" color="red"></a-sphere>
        <a-entity id="cylinderGroup1"></a-entity>
    </a-marker>

    <a-marker type="barcode" value="2" id="m2" registerevents>
        <a-sphere radius="0.10" color="red"></a-sphere>
        <a-entity id="cylinderGroup2"></a-entity>
    </a-marker>

    <a-marker type="barcode" value="3" id="m3" registerevents>
        <a-sphere radius="0.10" color="red"></a-sphere>
        <a-entity id="cylinderGroup3"></a-entity>
    </a-marker>

    <a-marker type="barcode" value="4" id="m4" registerevents>
        <a-sphere radius="0.10" color="red"></a-sphere>
        <a-entity id="cylinderGroup4"></a-entity>
    </a-marker>
	
    <a-entity camera></a-entity>
    <a-entity run></a-entity>
</a-scene>
</body>
</html>
